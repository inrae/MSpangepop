# .gitlab-ci.yml
variables:
  IMAGE_NAME: "msprime_box"
  DOCKER_BUILD_CONTEXT: "dependencies"

stages:
  - build

build-and-push-image:
  stage: build
  tags:
    - stable  # Use the same runners as your colleagues
  image:
    name: kaczmarj/apptainer:latest
    entrypoint: [""]
  script:
    - echo "ðŸ”¹ -> Building container from Dockerfile with Apptainer..."
    - cd ${DOCKER_BUILD_CONTEXT}
    
    # Build from Dockerfile
    - apptainer build --force ../msprime_box.sif docker-daemon://./Dockerfile
    
    # Alternative: Build directly from Dockerfile without docker-daemon
    # - apptainer build --force ../msprime_box.sif Dockerfile
    
    - cd ..
    
    # Push to registry with commit SHA tag
    - echo "ðŸ”¹ -> Pushing image ${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}..."
    - apptainer push --docker-username "${CI_REGISTRY_USER}" --docker-password "${CI_REGISTRY_PASSWORD}" msprime_box.sif oras://"${CI_REGISTRY_IMAGE}"/${IMAGE_NAME}:"${CI_COMMIT_SHORT_SHA}"
    
    # Push to registry with latest tag
    - echo "ðŸ”¹ -> Pushing image ${IMAGE_NAME}:latest..."
    - apptainer push --docker-username "${CI_REGISTRY_USER}" --docker-password "${CI_REGISTRY_PASSWORD}" msprime_box.sif oras://"${CI_REGISTRY_IMAGE}"/${IMAGE_NAME}:latest
    
    - echo "âœ… -> Images successfully pushed to registry."
  rules:
    - changes:
        - dependencies/Dockerfile
    - when: manual
      allow_failure: true