# .gitlab-ci.yml
variables:
  IMAGE_NAME: "msprime_box"
  DOCKER_BUILD_CONTEXT: "dependencies"

stages:
  - build

build-and-push-image:
  stage: build
  tags:
    - stable 
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - echo "ðŸ”¹ -> Logging into GitLab Container Registry..."
    - echo "${CI_REGISTRY_PASSWORD}" | docker login "${CI_REGISTRY}" -u "${CI_REGISTRY_USER}" --password-stdin
    - echo "âœ… -> Login successful."
  script:
    - echo "ðŸ”¹ -> Building Docker image from ${DOCKER_BUILD_CONTEXT}/Dockerfile..."
    - docker build -t "${CI_REGISTRY_IMAGE}/${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}" ${DOCKER_BUILD_CONTEXT}
    - docker tag "${CI_REGISTRY_IMAGE}/${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}" "${CI_REGISTRY_IMAGE}/${IMAGE_NAME}:latest"
    
    - echo "ðŸ”¹ -> Pushing images to registry..."
    - docker push "${CI_REGISTRY_IMAGE}/${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}"
    - docker push "${CI_REGISTRY_IMAGE}/${IMAGE_NAME}:latest"
    
    # If this is a tag, also push with version
    - |
      if [[ -n "${CI_COMMIT_TAG}" ]]; then
        docker tag "${CI_REGISTRY_IMAGE}/${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}" "${CI_REGISTRY_IMAGE}/${IMAGE_NAME}:${CI_COMMIT_TAG}"
        docker push "${CI_REGISTRY_IMAGE}/${IMAGE_NAME}:${CI_COMMIT_TAG}"
      fi
    
    - echo "âœ… -> Images successfully pushed to registry."
  rules:
    - changes:
        - dependencies/Dockerfile
    - if: $CI_COMMIT_TAG  # Also run on tags like your colleagues
    - when: manual
      allow_failure: true